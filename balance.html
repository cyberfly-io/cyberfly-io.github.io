<!DOCTYPE html>
<html lang="en" x-data="{ darkMode: localStorage.getItem('darkMode') !== 'false' }" :class="{ 'dark': darkMode }">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kadena Balance Checker</title>
    <script src="https://cdn.jsdelivr.net/npm/pact-lang-api@4.1.1/pact-lang-api-global.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- Prevent dark-mode flash -->
    <script>
        try {
            const ls = localStorage.getItem('darkMode');
            const sys = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (ls !== 'false' || (ls === null && sys)) document.documentElement.classList.add('dark');
        } catch(e) {}
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            transition: background 0.3s ease;
        }

        body.dark {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: background 0.3s ease;
        }

        .dark .container {
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            padding: 30px;
            text-align: center;
            color: white;
            position: relative;
        }

        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .dark-mode-toggle i {
            font-size: 1.2rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .search-section {
            padding: 30px;
            border-bottom: 1px solid #e0e6ed;
        }

        .dark .search-section {
            border-bottom-color: #374151;
        }

        .search-box {
            display: flex;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        .search-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e0e6ed;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            outline: none;
            background: white;
            color: #1e293b;
        }

        .dark .search-input {
            border-color: #374151;
            background: #1f2937;
            color: #f9fafb;
        }

        .search-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .search-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .search-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.3);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e0e6ed;
            border-top: 4px solid #4facfe;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .dark .spinner {
            border-color: #374151;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            padding: 30px;
            display: none;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e2e8f0;
            transition: background 0.3s ease;
        }

        .dark .stat-card {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-color: #4b5563;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 3px;
            transition: color 0.3s ease;
        }

        .dark .stat-value {
            color: #f9fafb;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: color 0.3s ease;
        }

        .dark .stat-label {
            color: #9ca3af;
        }

        .assets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .asset-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .dark .asset-card {
            background: #1f2937;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            border-color: #374151;
        }

        .asset-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #4facfe, #00f2fe);
        }

        .asset-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }

        .dark .asset-card:hover {
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
        }

        .asset-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .asset-info h3 {
            font-size: 1.2rem;
            color: #1e293b;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }

        .dark .asset-info h3 {
            color: #f9fafb;
        }

        .asset-symbol {
            background: #f1f5f9;
            color: #475569;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark .asset-symbol {
            background: #374151;
            color: #d1d5db;
        }

        .total-balance {
            font-size: 1.5rem;
            font-weight: 700;
            color: #059669;
            margin-bottom: 15px;
        }

        .chain-balance {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #4facfe;
            transition: background 0.3s ease;
        }

        .dark .chain-balance {
            background: #374151;
        }

        .chain-id {
            font-weight: 600;
            color: #475569;
            transition: color 0.3s ease;
        }

        .dark .chain-id {
            color: #d1d5db;
        }

        .balance-amount {
            font-weight: 600;
            color: #1e293b;
            transition: color 0.3s ease;
        }

        .dark .balance-amount {
            color: #f9fafb;
        }

        .error {
            text-align: center;
            padding: 40px;
            color: #dc2626;
            display: none;
        }

        .dark .error {
            color: #fca5a5;
        }

        .error-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .zero-balance {
            opacity: 0.6;
        }

        .zero-balance .total-balance {
            color: #9ca3af;
        }

        .dark .zero-balance .total-balance {
            color: #6b7280;
        }

        .price-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .token-price {
            color: #059669;
            font-weight: 600;
        }

        .kda-value {
            color: #7c3aed;
            font-weight: 600;
        }

        .usd-value {
            color: #059669;
            font-weight: 600;
        }

        .price-loading {
            color: #9ca3af;
            font-style: italic;
        }

        .price-error {
            color: #dc2626;
            font-size: 0.8rem;
        }

        .loading-prices {
            text-align: center;
            padding: 20px;
            color: #64748b;
            font-style: italic;
        }

        .dark .loading-prices {
            color: #9ca3af;
        }

        /* Small, subtle sub-label for price timestamp */
        #usdPriceAsOf {
            margin-top: 4px;
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Transactions Section Styles */
        .transactions-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .dark .transactions-section {
            border-top-color: #374151;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
        }

        .dark .section-header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: #334155;
        }

        .section-header h3 {
            font-size: 1.5rem;
            color: #1e293b;
            margin: 0;
            transition: color 0.3s ease;
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .dark .section-header h3 {
            color: #f9fafb;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 10px 18px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.2);
        }

        .refresh-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .refresh-btn:hover::before {
            left: 100%;
        }

        .refresh-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 172, 254, 0.4);
        }

        .transactions-loading, .transactions-error {
            text-align: center;
            padding: 40px;
        }

        .transactions-error {
            color: #dc2626;
        }

        .dark .transactions-error {
            color: #fca5a5;
        }

        .transactions-list {
            display: grid;
            gap: 15px;
        }

        .transaction-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .dark .transaction-item {
            background: #1f2937;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            border-color: #374151;
        }

        .transaction-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .dark .transaction-item:hover {
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .transaction-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .transaction-type {
            font-weight: 600;
            color: #059669;
            background: #dcfce7;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .dark .transaction-type {
            color: #10b981;
            background: #064e3b;
        }

        .transaction-type.error {
            color: #dc2626;
            background: #fef2f2;
        }

        .dark .transaction-type.error {
            color: #fca5a5;
            background: #7f1d1d;
        }

        .transaction-details {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .dark .transaction-details {
            color: #9ca3af;
        }

        .transaction-amount {
            font-weight: 600;
            color: #1e293b;
            margin-top: 10px;
        }

        .dark .transaction-amount {
            color: #f9fafb;
        }

        .transaction-index {
            font-size: 0.8rem;
            color: #64748b;
            background: #f1f5f9;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 500;
        }

        .dark .transaction-index {
            color: #9ca3af;
            background: #374151;
        }

        .transaction-events {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid #e2e8f0;
        }

        .dark .transaction-events {
            border-top-color: #374151;
        }

        .event-item {
            font-size: 0.85rem;
            color: #475569;
            background: #f8fafc;
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 5px;
            border-left: 3px solid #4facfe;
        }

        .dark .event-item {
            color: #cbd5e1;
            background: #1f2937;
        }

        .swap-item {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .swap-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 50%, #4facfe 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .swap-item:hover {
            transform: translateY(-2px) scale(1.01);
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.15);
            border-color: #4facfe;
        }

        .swap-item:hover::before {
            opacity: 1;
        }

        .dark .swap-item {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-color: #334155;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .dark .swap-item:hover {
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.25);
            border-color: #4facfe;
        }

        .swap-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .swap-icon {
            font-size: 18px;
            color: #4facfe;
            flex-shrink: 0;
            animation: pulse 2s infinite;
        }

        .swap-text {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            line-height: 1.4;
            flex: 1;
        }

        .dark .swap-text {
            color: #f1f5f9;
        }

        .swap-amount {
            font-weight: 600;
            color: #059669;
        }

        .dark .swap-amount {
            color: #10b981;
        }

        .swap-token {
            font-weight: 500;
            color: #7c3aed;
        }

        .dark .swap-token {
            color: #a78bfa;
        }

        .swap-arrow {
            color: #6b7280;
            margin: 0 8px;
        }

        .dark .swap-arrow {
            color: #9ca3af;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        .swap-item.fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .toggle-btn {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            color: #475569;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .dark .toggle-btn {
            background: linear-gradient(135deg, #374151 0%, #1f2937 100%);
            border-color: #4b5563;
            color: #d1d5db;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .dark .toggle-btn:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .toggle-btn i {
            transition: transform 0.3s ease;
        }

        .toggle-btn.expanded i {
            transform: rotate(180deg);
        }

        @media (max-width: 768px) {
            .search-box {
                flex-direction: column;
            }

            .header h1 {
                font-size: 2rem;
            }

            .assets-grid {
                grid-template-columns: 1fr;
            }

            .swap-item {
                padding: 14px 16px;
                margin-bottom: 10px;
            }

            .swap-content {
                gap: 10px;
            }

            .swap-icon {
                font-size: 16px;
            }

            .swap-text {
                font-size: 13px;
            }

            .section-header {
                flex-direction: column;
                gap: 12px;
                text-align: center;
                padding: 16px;
            }

            .section-header h3 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <button class="dark-mode-toggle" @click="darkMode = !darkMode; localStorage.setItem('darkMode', darkMode)" aria-label="Toggle dark mode">
                <i class="bi bi-sun-fill" x-show="!darkMode" aria-hidden="true"></i>
                <i class="bi bi-moon-fill" x-show="darkMode" aria-hidden="true"></i>
            </button>
            <h1>Kadena Balance Checker</h1>
            <p>Check your wallet balance across all chains with live KDA and USD prices</p>
        </div>

        <div class="search-section">
            <div class="search-box">
                <input 
                    type="text" 
                    class="search-input" 
                    id="accountInput" 
                    placeholder="Enter your Kadena account address..."
                    autocomplete="off"
                >
                <button class="search-btn" id="searchBtn" onclick="checkBalance()">
                    Check Balance
                </button>
            </div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Fetching your balance...</p>
        </div>

        <div class="error" id="error">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3>Error fetching balance</h3>
            <p id="errorMessage">Please check the account address and try again.</p>
        </div>

        <div class="results" id="results">
            <div class="summary-stats" id="summaryStats">
                <div class="stat-card">
                    <div class="stat-value" id="totalKdaWorth">0.00</div>
                    <div class="stat-label">Total KDA Worth</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalUsdWorth">$0.00</div>
                    <div class="stat-label">Total USD Worth</div>
                    <div class="stat-label" id="usdPriceAsOf"></div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalAssets">0</div>
                    <div class="stat-label">Total Assets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalTransactions">0</div>
                    <div class="stat-label">Transactions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeChains">0</div>
                    <div class="stat-label">Active Chains</div>
                </div>
            </div>

            <div class="assets-grid" id="assetsGrid">
                <!-- Assets will be populated here -->
            </div>

            <!-- Toggle Transactions Button -->
            <div class="toggle-section">
                <button class="toggle-btn" onclick="toggleTransactions()">
                    <span id="toggleText">Show Token Swap Transactions</span>
                    <i class="bi bi-chevron-down" id="toggleIcon"></i>
                </button>
            </div>

            <!-- Transactions Section -->
            <div class="transactions-section" id="transactionsSection" style="display: none;">
                <div class="section-header">
                    <h3>Swap Transactions</h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">Token swap transactions involving this account</p>
                    <button class="refresh-btn" onclick="fetchTransactions()">Refresh</button>
                </div>
                <div class="transactions-loading" id="transactionsLoading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Loading swap transactions...</p>
                </div>
                <div class="transactions-error" id="transactionsError" style="display: none;">
                    <p>Error loading swap transactions</p>
                </div>
                <div class="transactions-list" id="transactionsList">
                    <!-- Transactions will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <script>
    let currentAccount = '';
    let tokenPrices = new Map();
    let totalKdaWorth = 0;
    let kdaUsdPrice = 0;
    const MIN_VISIBLE_BALANCE = 1; // Hide assets below 1 KDA
        
        // GraphQL endpoint for Kadena
        const KADENA_GRAPHQL_ENDPOINT = 'https://graph.kadena.network/graphql';
        
        // Add enter key support
        document.getElementById('accountInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkBalance();
            }
        });

        async function getTokenPriceFromKaddex(tokenId) {
            try {
                console.log(`üîç Fetching price for token: ${tokenId}`);
                
                // Skip price lookup for KDA (base currency)
                if (tokenId === 'coin') {
                    return { kdaPrice: 1.0, source: 'base-currency' };
                }

                console.log(`Querying Kaddex pool for ${tokenId}/coin pair...`);

                // GraphQL query to get pair info
                const query = `
                    query GetPairInfo {
                        pactQuery(pactQuery: {
                            chainId: "2", 
                            code: "(kaddex.exchange.get-pair coin ${tokenId})"
                        }) {
                            result
                        }
                    }
                `;

                const response = await fetch(KADENA_GRAPHQL_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`GraphQL request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log(`GraphQL response for ${tokenId}:`, data);

                if (data.data && data.data.pactQuery && data.data.pactQuery.length > 0) {
                    const result = data.data.pactQuery[0].result;
                    
                    if (result && typeof result === 'string') {
                        try {
                            const pairData = JSON.parse(result);
                            console.log('Parsed pair data:', pairData);
                            
                            if (pairData && pairData.leg0 && pairData.leg1) {
                                // Handle reserve as either number or object with decimal property
                                const leg0Reserve = typeof pairData.leg0.reserve === 'object' && pairData.leg0.reserve.decimal 
                                    ? parseFloat(pairData.leg0.reserve.decimal) 
                                    : parseFloat(pairData.leg0.reserve);
                                const leg1Reserve = typeof pairData.leg1.reserve === 'object' && pairData.leg1.reserve.decimal 
                                    ? parseFloat(pairData.leg1.reserve.decimal) 
                                    : parseFloat(pairData.leg1.reserve);
                                
                                console.log(`Reserves - Leg0: ${leg0Reserve}, Leg1: ${leg1Reserve}`);
                                
                                // Simple price calculation: leg1_reserve / leg0_reserve
                                const kdaPrice =  leg0Reserve/leg1Reserve
                                
                                if (kdaPrice > 0) {
                                    console.log(`‚úÖ Found price for ${tokenId}: ${kdaPrice} KDA`);
                                    return { kdaPrice, source: 'kaddex-pool', pairData };
                                }
                            }
                        } catch (parseError) {
                            console.error('Error parsing pair data:', parseError);
                        }
                    }
                }

                console.log(`‚ö†Ô∏è No price data found for ${tokenId} on Kaddex`);
                return { kdaPrice: 0, source: 'unavailable' };
                
            } catch (error) {
                console.error(`‚ùå Error fetching price for ${tokenId}:`, error);
                return { kdaPrice: 0, source: 'error', error: error.message };
            }
        }

        async function fetchAllTokenPrices(assets) {
            console.log('üí∞ Fetching token prices from Kaddex...');
            const pricePromises = assets.map(async (asset) => {
                const price = await getTokenPriceFromKaddex(asset.assetId);
                tokenPrices.set(asset.assetId, price);
                return { assetId: asset.assetId, price };
            });

            await Promise.all(pricePromises);
            console.log('‚úÖ All token prices fetched');
        }

    async function getKdaUsdPrice() {
            try {
                console.log('üíµ Fetching KDA/USD price from DIA oracle...');
                
                const query = `
                    query GetKdaUsdPrice {
                        pactQuery(
                            pactQuery: {chainId: "1", code: "(n_bfb76eab37bf8c84359d6552a1d96a309e030b71.dia-oracle.get-value \\"KDA/USD\\" )"}
                        ) {
                            result
                        }
                    }
                `;

                const response = await fetch(KADENA_GRAPHQL_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`GraphQL request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('KDA/USD response:', data);

                if (data.data && data.data.pactQuery && data.data.pactQuery.length > 0) {
                    const result = data.data.pactQuery[0].result;
                    
                    if (result && typeof result === 'string') {
                        try {
                            const priceData = JSON.parse(result);
                            console.log('Parsed KDA/USD data:', priceData);
                            
                            // Handle multiple possible DIA response shapes
                            // Examples:
                            // { value: 0.3713929895, timestamp: { time: "..." } }
                            // { value: { decimal: "0.3713929895" }, timestamp: { time: "..." } }
                            // { value: "0.3713929895" }
                            let usdPrice = 0;
                            let asOfIso = undefined;
                            if (priceData && Object.prototype.hasOwnProperty.call(priceData, 'value')) {
                                const v = priceData.value;
                                if (typeof v === 'number') {
                                    usdPrice = v;
                                } else if (typeof v === 'string') {
                                    const parsed = parseFloat(v);
                                    if (!Number.isNaN(parsed)) usdPrice = parsed;
                                } else if (v && typeof v === 'object') {
                                    if (v.decimal !== undefined) {
                                        const parsed = parseFloat(v.decimal);
                                        if (!Number.isNaN(parsed)) usdPrice = parsed;
                                    } else if (v.int !== undefined) {
                                        const parsed = parseFloat(v.int);
                                        if (!Number.isNaN(parsed)) usdPrice = parsed;
                                    }
                                }
                                // capture timestamp if provided
                                if (priceData.timestamp && priceData.timestamp.time) {
                                    asOfIso = priceData.timestamp.time;
                                }
                            }

                            if (Number.isFinite(usdPrice) && usdPrice > 0) {
                                console.log(`‚úÖ KDA/USD price: $${usdPrice}`, asOfIso ? `(as of ${asOfIso})` : '');
                                return { price: usdPrice, asOf: asOfIso };
                            }
                        } catch (parseError) {
                            console.error('Error parsing KDA/USD data:', parseError);
                        }
                    }
                }

                console.log('‚ö†Ô∏è No KDA/USD price data found');
                return { price: 0 };
                
            } catch (error) {
                console.error('‚ùå Error fetching KDA/USD price:', error);
                return { price: 0 };
            }
        }

        function calculateKdaWorth(asset) {
            const balance = parseFloat(asset.totalBalance) || 0;
            const priceInfo = tokenPrices.get(asset.assetId);
            
            if (!priceInfo || priceInfo.kdaPrice === 0) {
                return 0;
            }
            
            return balance * priceInfo.kdaPrice;
        }

        async function checkBalance() {
            const accountInput = document.getElementById('accountInput');
            const account = accountInput.value.trim();
            
            if (!account) {
                alert('Please enter an account address');
                return;
            }

            currentAccount = account;
            
            // Update URL with account parameter
            const url = new URL(window.location);
            url.searchParams.set('account', account);
            window.history.pushState({}, '', url);
            
            showLoading();
            hideError();
            hideResults();
            
            // Clear previous data
            tokenPrices.clear();
            totalKdaWorth = 0;

            try {
                const url = `https://node.cyberfly.io/api/balance/${encodeURIComponent(account)}`;
                console.log('üöÄ Testing API call to:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    mode: 'cors'
                });
                
                console.log('‚úÖ Balance request successful!');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Server error ${response.status}: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('‚úÖ Balance data received');
                
                // Display results first
                displayResults(data);
                
                // Then fetch prices in background
                if (data.assets && data.assets.length > 0) {
                    console.log('üîÑ Starting price fetch process...');
                    showPriceLoading();
                    await fetchAllTokenPrices(data.assets);
                    
                    // Fetch KDA/USD price
                    const usdInfo = await getKdaUsdPrice();
                    kdaUsdPrice = usdInfo.price || 0;
                    if (usdInfo.asOf) {
                        try {
                            const dt = new Date(usdInfo.asOf);
                            // Format as local time string
                            const pretty = dt.toLocaleString(undefined, { hour12: false });
                            const el = document.getElementById('usdPriceAsOf');
                            if (el) el.textContent = `As of ${pretty}`;
                        } catch {}
                    }
                    updateResultsWithPrices(data);
                }
                
            } catch (error) {
                console.error('‚ùå Request failed:', error);
                
                let errorMessage = '';
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    errorMessage = 'Network request failed - check CORS configuration and server status.';
                } else {
                    errorMessage = `Error: ${error.message}`;
                }
                
                showError(errorMessage);
            } finally {
                hideLoading();
            }
        }

        function displayResults(data) {
            // Filter assets with meaningful balances (‚â• MIN_VISIBLE_BALANCE)
            const visibleAssets = data.assets?.filter(asset => {
                const balance = parseFloat(asset.totalBalance) || 0;
                return balance >= MIN_VISIBLE_BALANCE;
            }) || [];

            // Update summary stats
            document.getElementById('totalAssets').textContent = visibleAssets.length;
            document.getElementById('totalTransactions').textContent = data.totalTransactions || 0;
            document.getElementById('totalKdaWorth').textContent = '0.00';
            document.getElementById('totalUsdWorth').textContent = '$0.00';
            
            // Calculate active chains from visible assets only
            const activeChains = new Set();
            visibleAssets.forEach(asset => {
                asset.balances?.forEach(balance => {
                    if (parseFloat(balance.balance) > 0) {
                        activeChains.add(balance.chainId);
                    }
                });
            });
            document.getElementById('activeChains').textContent = activeChains.size;

            // Display assets (filter out very low balance assets)
            const assetsGrid = document.getElementById('assetsGrid');
            assetsGrid.innerHTML = '';

            if (!data.assets || data.assets.length === 0) {
                assetsGrid.innerHTML = '<p style="text-align: center; color: #64748b;">No assets found for this account.</p>';
                showResults();
                return;
            }

            // Filter assets with meaningful balances (‚â• MIN_VISIBLE_BALANCE)
            const filteredAssets = data.assets.filter(asset => {
                const balance = parseFloat(asset.totalBalance) || 0;
                return balance >= MIN_VISIBLE_BALANCE;
            });

            if (filteredAssets.length === 0) {
                assetsGrid.innerHTML = '<p style="text-align: center; color: #64748b;">No assets with balances of at least 1 KDA found.</p>';
            } else {
                filteredAssets.forEach(asset => {
                    const assetCard = createAssetCard(asset);
                    assetsGrid.appendChild(assetCard);
                });
            }

            showResults();
        }

        function updateResultsWithPrices(data) {
            console.log('üîÑ Updating results with price data...');
            
            // Recalculate total KDA worth
            totalKdaWorth = 0;
            
            data.assets?.forEach(asset => {
                const kdaWorth = calculateKdaWorth(asset);
                totalKdaWorth += kdaWorth;
                console.log(`${asset.symbol}: ${asset.totalBalance} √ó ${tokenPrices.get(asset.assetId)?.kdaPrice || 0} = ${kdaWorth} KDA`);
            });
            
            // Update total KDA worth display
            document.getElementById('totalKdaWorth').textContent = formatBalance(totalKdaWorth);
            
            // Calculate and display total USD worth
            const totalUsdWorth = totalKdaWorth * kdaUsdPrice;
            document.getElementById('totalUsdWorth').textContent = kdaUsdPrice > 0 ? `$${formatBalance(totalUsdWorth)}` : '$0.00';
            
            // Update individual asset cards with price info (filter out very low balance assets)
            const assetsGrid = document.getElementById('assetsGrid');
            assetsGrid.innerHTML = '';
            
            // Filter assets with meaningful balances (‚â• MIN_VISIBLE_BALANCE)
            const pricedAssets = data.assets.filter(asset => {
                const balance = parseFloat(asset.totalBalance) || 0;
                return balance >= MIN_VISIBLE_BALANCE;
            });

            if (pricedAssets.length === 0) {
                assetsGrid.innerHTML = '<p style="text-align: center; color: #64748b;">No assets with balances of at least 1 KDA found.</p>';
            } else {
                pricedAssets.forEach(asset => {
                    const assetCard = createAssetCard(asset, true); // true = include price info
                    assetsGrid.appendChild(assetCard);
                });
            }
            
            console.log(`üí∞ Total portfolio value: ${totalKdaWorth} KDA ($${totalUsdWorth})`);
        }

        function showPriceLoading() {
            const assetsGrid = document.getElementById('assetsGrid');
            const existingLoading = document.querySelector('.loading-prices');
            if (existingLoading) existingLoading.remove();
            
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'loading-prices';
            loadingDiv.innerHTML = 'üí∞ Fetching token prices from Kaddex exchange and KDA/USD rate from DIA oracle...';
            assetsGrid.appendChild(loadingDiv);
        }

        function createAssetCard(asset, includePrices = false) {
            const card = document.createElement('div');
            const hasBalance = parseFloat(asset.totalBalance) > 0;
            card.className = `asset-card ${!hasBalance ? 'zero-balance' : ''}`;

            const chainBalancesHtml = asset.balances?.map(balance => `
                <div class="chain-balance">
                    <span class="chain-id">Chain ${balance.chainId}</span>
                    <span class="balance-amount">${formatBalance(balance.balance)}</span>
                </div>
            `).join('') || '';

            let priceInfoHtml = '';
            let kdaValueHtml = '';
            
            if (includePrices) {
                const priceInfo = tokenPrices.get(asset.assetId);
                const kdaWorth = calculateKdaWorth(asset);
                
                if (priceInfo) {
                    if (priceInfo.source === 'base-currency') {
                        priceInfoHtml = `
                            <div class="price-info">
                                <span>Base Currency (KDA)</span>
                                <span class="token-price">1.00 KDA</span>
                            </div>
                        `;
                    } else if (priceInfo.kdaPrice > 0) {
                        priceInfoHtml = `
                            <div class="price-info">
                                <span>Price per token</span>
                                <span class="token-price">${formatBalance(priceInfo.kdaPrice)} KDA</span>
                            </div>
                        `;
                    } else {
                        priceInfoHtml = `
                            <div class="price-info">
                                <span class="price-error">Price not available on Kaddex</span>
                            </div>
                        `;
                    }
                    
                    if (kdaWorth > 0) {
                        const usdWorth = kdaWorth * kdaUsdPrice;
                        kdaValueHtml = `
                            <div class="price-info">
                                <span><strong>Total KDA Value</strong></span>
                                <span class="kda-value">${formatBalance(kdaWorth)} KDA</span>
                            </div>
                            ${kdaUsdPrice > 0 ? `
                            <div class="price-info">
                                <span><strong>Total USD Value</strong></span>
                                <span class="usd-value">$${formatBalance(usdWorth)}</span>
                            </div>
                            ` : ''}
                        `;
                    }
                } else {
                    priceInfoHtml = `
                        <div class="price-info">
                            <span class="price-loading">Loading price...</span>
                        </div>
                    `;
                }
            }

            card.innerHTML = `
                <div class="asset-header">
                    <div class="asset-info">
                        <h3>${asset.name}</h3>
                        <div class="asset-symbol">${asset.symbol}</div>
                    </div>
                </div>
                <div class="total-balance">${formatBalance(asset.totalBalance)}</div>
                ${priceInfoHtml}
                ${kdaValueHtml}
                <div class="chain-balances">
                    ${chainBalancesHtml}
                </div>
            `;

            return card;
        }

        function formatBalance(balance) {
            const num = parseFloat(balance);
            if (num === 0) return '0';
            if (num < 0.000001) return num.toExponential(2);
            if (num < 1) return num.toFixed(6).replace(/\.?0+$/, '');
            if (num < 1000) return num.toFixed(4).replace(/\.?0+$/, '');
            return num.toLocaleString(undefined, {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('searchBtn').textContent = 'Loading...';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('searchBtn').disabled = false;
            document.getElementById('searchBtn').textContent = 'Check Balance';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').style.display = 'block';
        }

        function hideError() {
            document.getElementById('error').style.display = 'none';
        }

        function showResults() {
            document.getElementById('results').style.display = 'block';
        }

        function hideResults() {
            document.getElementById('results').style.display = 'none';
        }

        // Debug function to test GraphQL API
        window.testGraphQLAPI = function() {
            console.log('üß™ Testing GraphQL API connection...');
            
            const testQuery = `
                query TestQuery {
                    pactQuery(pactQuery: {
                        chainId: "2", 
                        code: "(kaddex.exchange.get-pair coin free.cyberfly_token)"
                    }) {
                        result
                    }
                }
            `;

            fetch(KADENA_GRAPHQL_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify({ query: testQuery })
            })
            .then(response => response.json())
            .then(data => {
                console.log('‚úÖ GraphQL test successful:', data);
            })
            .catch(error => {
                console.error('‚ùå GraphQL test failed:', error);
            });
        };

        // Function to get account from URL params or hash
        function getAccountFromUrl() {
            // Check URL hash first (e.g., #k:account)
            if (window.location.hash) {
                const hashAccount = window.location.hash.substring(1); // remove #
                if (hashAccount && hashAccount.startsWith('k:')) {
                    return hashAccount;
                }
            }
            
            // Check URL query parameters (e.g., ?account=k:account)
            const urlParams = new URLSearchParams(window.location.search);
            const paramAccount = urlParams.get('account');
            if (paramAccount && paramAccount.startsWith('k:')) {
                return paramAccount;
            }
            
            return null;
        }

        // Auto-load account and test GraphQL API on load
        window.addEventListener('load', function() {
            // Check for account in URL
            const urlAccount = getAccountFromUrl();
            if (urlAccount) {
                console.log('üîó Found account in URL:', urlAccount);
                document.getElementById('accountInput').value = urlAccount;
                // Auto-fetch balance after a short delay
                setTimeout(() => {
                    checkBalance();
                }, 500);
            }
            
            setTimeout(() => {
                console.log('üîß Auto-testing GraphQL API...');
                console.log('GraphQL endpoint:', KADENA_GRAPHQL_ENDPOINT);
            }, 1000);
        });

        // Listen for hash changes to support direct navigation
        window.addEventListener('hashchange', function() {
            const urlAccount = getAccountFromUrl();
            if (urlAccount) {
                console.log('üîó Hash changed, found account:', urlAccount);
                document.getElementById('accountInput').value = urlAccount;
                checkBalance();
            }
        });

        // Transactions functionality
        let transactionsVisible = false;

        function toggleTransactions() {
            const section = document.getElementById('transactionsSection');
            const toggleBtn = document.querySelector('.toggle-btn');
            const toggleText = document.getElementById('toggleText');
            const toggleIcon = document.getElementById('toggleIcon');

            transactionsVisible = !transactionsVisible;

            if (transactionsVisible) {
                section.style.display = 'block';
                toggleBtn.classList.add('expanded');
                toggleText.textContent = 'Hide Token Swap Transactions';
                fetchTransactions();
            } else {
                section.style.display = 'none';
                toggleBtn.classList.remove('expanded');
                toggleText.textContent = 'Show Token Swap Transactions';
            }
        }

        async function fetchTransactions() {
            if (!currentAccount) {
                alert('Please check balance first to load transactions');
                return;
            }

            showTransactionsLoading();
            hideTransactionsError();

            try {
                                console.log('üìä Fetching transfers for account:', currentAccount);

                                const query = `
                                        query GetTransfers {
                                            transfers(
                                                accountName: "${currentAccount}"
                                                first: 100
                                            ) {
                                                edges {
                                                    node {
                                                        requestKey
                                                        transaction {
                                                            result {
                                                                ... on TransactionResult {
                                                                    goodResult
                                                                }
                                                            }
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                `;

                const response = await fetch(KADENA_GRAPHQL_ENDPOINT, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error(`GraphQL request failed: ${response.status}`);
                }

                const data = await response.json();
                console.log('üìä Transfers response:', data);

                // Check for GraphQL errors
                if (data.errors) {
                    console.error('GraphQL errors:', data.errors);
                    throw new Error(`GraphQL error: ${data.errors[0].message}`);
                }

                // Check different possible response structures
                if (data.data) {
                    if (data.data.transfers && data.data.transfers.edges) {
                        displayTransactions(data.data.transfers.edges);
                    } else {
                        console.log('Available data keys:', Object.keys(data.data));
                        throw new Error('Transfers data not found in response. Available: ' + Object.keys(data.data).join(', '));
                    }
                } else {
                    console.log('Response structure:', data);
                    throw new Error('Invalid response format - no data field');
                }

            } catch (error) {
                console.error('‚ùå Error fetching transactions:', error);
                showTransactionsError('Failed to load transactions: ' + error.message);
            } finally {
                hideTransactionsLoading();
            }
        }

        function displayTransactions(edges) {
            const container = document.getElementById('transactionsList');
            container.innerHTML = '';

            if (!edges || edges.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #64748b; padding: 40px;">No swap transactions found.</p>';
                return;
            }

            // Deduplicate by requestKey if present
            const seen = new Set();
            edges.forEach((edge, index) => {
                const rk = edge?.node?.requestKey;
                if (rk) {
                    if (seen.has(rk)) return;
                    seen.add(rk);
                }
                const transferNode = edge.node;
                const item = createTransferItem(transferNode, index);
                if (item) container.appendChild(item);
            });

            if (container.children.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üîÑ</div>
                        <h4 style="color: #64748b; margin-bottom: 8px; font-weight: 600;">No Swap Transactions Found</h4>
                        <p style="color: #94a3b8; font-size: 0.9rem;">This account hasn't performed any token swap transactions yet.</p>
                    </div>
                `;
            }
        }

        function createTransferItem(node, index) {
            // Expect node.transaction.result.goodResult to be a JSON string of array
            const gr = node?.transaction?.result?.goodResult;
            if (!gr || typeof gr !== 'string') return null;
            let arr;
            try {
                arr = JSON.parse(gr);
            } catch {
                return null;
            }
            if (!Array.isArray(arr) || arr.length < 2) return null;
            // Heuristic: treat first element as token given, second as token received (or vice-versa)
            // We'll prefer swaps where one leg is 'coin' and the other is not.
            let legA = arr[0];
            let legB = arr[1];
            if (!legA || !legB || legA.amount == null || legB.amount == null) return null;

            // Normalize
            const tokA = legA.token || 'Unknown';
            const tokB = legB.token || 'Unknown';
            const amtA = Number(legA.amount) || 0;
            const amtB = Number(legB.amount) || 0;

            if (amtA <= 0 || amtB <= 0) return null;

            // Decide direction: If tokA is coin and tokB not coin => swapped amtA coin for amtB tokB
            // Else if tokB is coin and tokA not coin => swapped amtB coin for amtA tokA
            // Else default to A for B
            let amountIn, tokenIn, amountOut, tokenOut;
            if (tokA === 'coin' && tokB !== 'coin') {
                amountIn = amtA; tokenIn = tokA; amountOut = amtB; tokenOut = tokB;
            } else if (tokB === 'coin' && tokA !== 'coin') {
                amountIn = amtB; tokenIn = tokB; amountOut = amtA; tokenOut = tokA;
            } else {
                amountIn = amtA; tokenIn = tokA; amountOut = amtB; tokenOut = tokB;
            }

            const formattedAmountIn = amountIn.toLocaleString('en-US', { maximumFractionDigits: 6 });
            const formattedAmountOut = amountOut.toLocaleString('en-US', { maximumFractionDigits: 6 });

            const item = document.createElement('div');
            item.className = 'swap-item fade-in';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'swap-content';

            const iconDiv = document.createElement('div');
            iconDiv.className = 'swap-icon';
            iconDiv.textContent = 'üîÑ';
            contentDiv.appendChild(iconDiv);

            const textDiv = document.createElement('div');
            textDiv.className = 'swap-text';

            // Build styled line: Swapped X tokenIn for Y tokenOut
            textDiv.innerHTML = `Swapped <span class="swap-amount">${formattedAmountIn}</span> <span class="swap-token">${tokenIn}</span> <span class="swap-arrow">for</span> <span class="swap-amount">${formattedAmountOut}</span> <span class="swap-token">${tokenOut}</span>`;

            contentDiv.appendChild(textDiv);

            // Explorer link
            const rk = node?.requestKey;
            if (rk && typeof rk === 'string') {
                const link = document.createElement('a');
                link.href = `https://kdaexplorer.com/tx-details/${rk}`;
                link.target = '_blank';
                link.rel = 'noopener noreferrer';
                link.textContent = 'View';
                link.style.marginLeft = 'auto';
                link.style.fontSize = '12px';
                link.style.fontWeight = '600';
                link.style.color = '#4facfe';
                link.style.textDecoration = 'none';
                link.onmouseenter = () => link.style.textDecoration = 'underline';
                link.onmouseleave = () => link.style.textDecoration = 'none';
                contentDiv.appendChild(link);
            }
            item.appendChild(contentDiv);
            return item;
        }


        function showTransactionsLoading() {
            document.getElementById('transactionsLoading').style.display = 'block';
            document.getElementById('transactionsList').style.display = 'none';
        }

        function hideTransactionsLoading() {
            document.getElementById('transactionsLoading').style.display = 'none';
            document.getElementById('transactionsList').style.display = 'block';
        }

        function showTransactionsError(message) {
            const errorDiv = document.getElementById('transactionsError');
            errorDiv.innerHTML = `<p>${message}</p>`;
            errorDiv.style.display = 'block';
        }

        function hideTransactionsError() {
            document.getElementById('transactionsError').style.display = 'none';
        }
    </script>
</body>
</html>